# Java 21 虚拟线程配置说明

## 🎯 概述

本项目已启用Java 21的虚拟线程（Virtual Threads）支持，这是Java平台的一个重大突破，可以显著提升高并发场景下的性能。

## 🚀 虚拟线程优势

### 📊 性能对比
- **传统线程**: 受限于操作系统线程数量（通常几千个）
- **虚拟线程**: 可创建数百万个，内存开销极小

### 💡 适用场景
- 高并发I/O密集型任务
- 大量短生命周期任务
- 需要大量并发连接的Web服务
- 异步任务处理

## ⚙️ 配置详情

### 1. 应用配置 (`application.yml`)
```yaml
server:
  tomcat:
    # 启用Tomcat虚拟线程支持
    use-virtual-threads: true
    threads.max: 200
    max-connections: 500

spring:
  # 全局虚拟线程配置
  threads:
    virtual:
      enabled: true
  # 异步任务执行器使用虚拟线程
  task:
    execution:
      pool:
        virtual-threads: true
    scheduling:
      pool:
        virtual-threads: true
```

### 2. Java配置类 (`VirtualThreadsConfig.java`)
- **主要任务执行器**: 使用`VirtualThreadTaskExecutor`
- **异步方法支持**: `@Async`注解自动使用虚拟线程
- **定时任务支持**: 定时任务也使用虚拟线程
- **降级策略**: 当虚拟线程不可用时自动降级到传统线程池

## 🧪 测试接口

### 基础测试
```bash
# 虚拟线程信息
GET /api/virtual-threads/info

# 性能测试（100个并发任务）
GET /api/virtual-threads/test?taskCount=100

# 压力测试（10000个虚拟线程）
GET /api/virtual-threads/stress-test?threadCount=10000
```

### 预期结果
- ✅ 线程信息显示"是否虚拟线程: ✅ 是"
- ⚡ 性能测试展示优异的并发处理能力
- 🚀 压力测试能轻松创建数万个虚拟线程

## 📈 性能监控

### JVM参数建议
```bash
# 启动时添加以下JVM参数来监控虚拟线程
-XX:+UnlockExperimentalVMOptions
-XX:+EnableJVMCI
--enable-preview
```

### 监控指标
- 虚拟线程创建数量
- 传统线程池使用情况
- 内存消耗对比
- 响应时间改善

## 🔧 最佳实践

### 1. 适合虚拟线程的场景
```java
@Async("asyncExecutor")
public CompletableFuture<String> ioIntensiveTask() {
    // I/O密集型任务：文件读写、网络请求、数据库查询
    return CompletableFuture.completedFuture("result");
}
```

### 2. 不适合虚拟线程的场景
- CPU密集型计算任务
- 需要pinning到特定CPU核心的任务
- 使用ThreadLocal的敏感操作

### 3. 代码迁移建议
```java
// 之前的代码
@Async
public void processData() {
    // 处理逻辑
}

// 无需修改！虚拟线程会自动应用
@Async("asyncExecutor")  // 可选：显式指定虚拟线程执行器
public void processData() {
    // 相同的处理逻辑，但现在使用虚拟线程
}
```

## 🎯 升级效果

### 预期改进
- **并发能力**: 提升10-100倍
- **内存使用**: 减少50-80%
- **响应延迟**: 降低20-50%
- **系统吞吐**: 提升2-5倍

### 兼容性
- ✅ Spring Boot 3.2+
- ✅ Java 21+
- ✅ 现有代码无需修改
- ✅ 自动降级支持

## 🔍 故障排除

### 常见问题
1. **虚拟线程未启用**
   - 检查Java版本是否为21+
   - 确认`spring.threads.virtual.enabled=true`

2. **性能未提升**
   - 确认任务是I/O密集型
   - 检查是否有线程pinning问题

3. **兼容性问题**
   - 某些第三方库可能不兼容
   - 使用降级策略切换到传统线程池

### 日志监控
```yaml
logging:
  level:
    org.springframework.core.task: DEBUG
    com.ld.poetry.config.VirtualThreadsConfig: DEBUG
```

---

**🎉 虚拟线程让您的应用在高并发场景下如虎添翼！** 